version: '2.2'

services:
  postgres:
    build: postgres/
    environment:
      - POSTGRES_USER=greenapperdba
      - POSTGRES_PASSWORD=supersecretpassword
      - POSTGRES_DB=groupomania
      - PGDATA=/var/lib/postgresql/data/pgdata
    ports:
      - "127.0.0.1:5432:5432"
    restart: always
    mem_limit: 2G
    cpu_shares: 500 # Default val is 1024, lower values increase CPU priority
    pids_limit: 64 # Limits num of processes running in container, prevents fork bombs for example
    read_only: true # Makes container read only
    tmpfs:
      # For read-only filesystem, need to create a volume/tmpfs for PostgreSQL to run its much
      # needed configuration. The read-only flag does not make volumes and tmpfs read-only.
      - /tmp
      - /run
      - /run/postgresql
  rabbitmq:
    image: rabbitmq:3-management
    ports:
      - "127.0.0.1:5672:5672"
      - "127.0.0.1:15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=greenapperadmin
      - RABBITMQ_DEFAULT_PASS=supersecretpassword
  # Mongo replica set nodes (using 3)
  mongorsn1:
    build: mongo/shard
    command: mongod --shardsvr --replSet mongors1 --keyFile /tmp/mongodb-keyfile --dbpath /data/db --port 27017
    ports:
      - 27017:27017
    volumes:
      - /mongo_cluster/data1:/data/db
  mongors1n2:
    build: mongo/shard
    command: mongod --shardsvr --replSet mongors1 --keyFile /tmp/mongodb-keyfile --dbpath /data/db --port 27017
    ports:
      - 27018:27017
    volumes:
      - /mongo_cluster/data2:/data/db
  mongors1n3:
    build: mongo/shard
    command: mongod --shardsvr --replSet mongors1 --keyFile /tmp/mongodb-keyfile --dbpath /data/db --port 27017
    ports:
      - 27019:27017
    volumes:
      - /mongo_cluster/data3:/data/db
  # 2 Mongo config servers
  mongocfg1:
    build: mongo/config
    command: mongod --configsvr --replSet mongors1conf --keyFile /tmp/mongodb-keyfile --dbpath /data/db --port 27017
    volumes:
      - /mongo_cluster/config1:/data/db
  mongocfg2:
    build: mongo/config
    command: mongod --configsvr --replSet mongors1conf --keyFile /tmp/mongodb-keyfile --dbpath /data/db --port 27017
    volumes:
      - /mongo_cluster/config2:/data/db
  # Mongo router
  mongos1:
    build: mongo/router
    depends_on:
      - mongocfg1
      - mongocfg2
    command: mongos --keyFile /tmp/mongodb-keyfile --configdb mongors1conf/mongocfg1:27017,mongocfg2:27017 --port 27017
    ports:
      - 27020:27017